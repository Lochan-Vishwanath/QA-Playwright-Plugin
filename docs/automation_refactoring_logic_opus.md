# Automated Refactoring Logic (OPUS Edition)
## A Concrete Example: Refactoring Theme Toggle Code into CBP-Test-Automation

**Document Purpose:** This is a fully annotated, step-by-step walkthrough of an actual refactoring execution. It demonstrates the application of the Universal Refactoring Strategy to a real-world scenario. This document serves as a "Worked Example" for both human developers and LLMs learning to execute the refactoring pipeline.

**Use Case:** Refactoring raw Playwright `codegen` output for a "Theme Toggle" test into the `cbp-test-automation` repository.

---

## Table of Contents
1.  [The Raw Input](#1-the-raw-input)
2.  [Phase I Execution: Reconnaissance](#2-phase-i-execution-reconnaissance)
3.  [Phase II Execution: Parsing](#3-phase-ii-execution-parsing)
4.  [Phase III Execution: Mapping](#4-phase-iii-execution-mapping)
5.  [Phase IV Execution: Code Generation](#5-phase-iv-execution-code-generation)
6.  [Phase V Execution: Verification](#6-phase-v-execution-verification)
7.  [Tool Invocation Log](#7-tool-invocation-log)
8.  [LLM vs Tool Responsibility Matrix](#8-llm-vs-tool-responsibility-matrix)

---

## 1. The Raw Input

### 1.1 Original Codegen Output

**File:** `test.spec.ts` (Generated by `npx playwright codegen`)

```typescript
import { test, expect } from '@playwright/test';

test('test', async ({ page }) => {
  await page.goto('https://cloudbees.io/');
  
  // Login
  await page.getByRole('textbox', { name: 'Email' }).fill('user@example.com');
  await page.getByRole('textbox', { name: 'Password' }).fill('password123');
  await page.getByRole('button', { name: 'Sign in' }).click();
  await page.waitForURL('**/home');
  
  // Theme Toggle
  await page.getByTestId('user-profile-dropdown').click();
  const themeToggle = page.getByTestId('theme-switcher');
  const currentTheme = await themeToggle.textContent();
  
  if (currentTheme?.includes('Dark mode')) {
    await themeToggle.click();
    await expect(page.locator('main')).toHaveCSS('background-color', 'rgb(26, 26, 26)');
  } else {
    await themeToggle.click();
    await expect(page.locator('main')).toHaveCSS('background-color', 'rgb(250, 250, 250)');
  }
});
```

### 1.2 Analysis Goal

Transform this monolithic script into:
1.  **Modified Page Objects:** Update `LoginPage.ts` and `LayoutPage.ts` with reusable components.
2.  **New Test File:** Create `theme.smoke.test.ts` that uses the POM structure.

---

## 2. Phase I Execution: Reconnaissance

### 2.1 Tool Invocation: `list_dir`

**Purpose:** Discover repository structure.

**Command:**
```
list_dir("/Users/lvishwanath/Documents/cbp-test-automation")
```

**Output (Partial):**
```
├── pages/
│   ├── basePage.ts
│   ├── fixture.ts
│   ├── layoutPage.ts
│   ├── loginPage.ts
│   └── ...
├── tests/
│   ├── core/
│   ├── login/
│   └── smoke/
├── utils/
│   ├── testTags.ts
│   └── background.ts
├── playwright.config.ts
└── ...
```

**LLM Interpretation:**
*   `pages/` exists -> **Standard POM structure detected**.
*   `tests/` exists -> **Test files are separated**.
*   `pages/fixture.ts` exists -> **Fixture-based injection pattern**.

**Result: RepoContext**
```json
{
  "repoType": "STANDARD_POM",
  "pageObjectDir": "pages/",
  "testDir": "tests/",
  "usesFixtures": true,
  "fixtureFile": "pages/fixture.ts"
}
```

### 2.2 Tool Invocation: `view_file` (Pattern Recognition)

**Purpose:** Detect coding style.

**Command:**
```
view_file("/Users/lvishwanath/Documents/cbp-test-automation/pages/layoutPage.ts", startLine=1, endLine=50)
```

**Output (Relevant Excerpt):**
```typescript
import { Page } from '@playwright/test'
import { BasePage } from './basePage'
import { WebControl } from './controls/webControl'

export default class LayoutPage extends BasePage {
  public welcomeTitle = new WebControl(
    this.page.getByTestId('welcome-title'),
    'Welcome Title'
  )
  
  public userProfileBtn = new WebControl(
    this.page.getByTestId('user-profile-dropdown'),
    'User Profile Button'
  )
  
  // ...
}
```

**LLM Interpretation:**
1.  **Locator Style:** `WrapperClass` (uses `new WebControl(...)`).
2.  **Wrapper Class Name:** `WebControl`.
3.  **Base Class:** `BasePage`.
4.  **Property Visibility:** `public`.
5.  **Locator Expression:** Uses `this.page.getByTestId(...)`.

**Result: StyleVector**
```json
{
  "locatorStyle": "WrapperClass",
  "wrapperClassName": "WebControl",
  "baseClassName": "BasePage",
  "propertyVisibility": "public",
  "methodStyle": "Atomic",
  "importStatements": ["import { WebControl } from './controls/webControl'"]
}
```

### 2.3 Tool Invocation: `view_file` (Fixture Registry)

**Purpose:** Understand how Page Objects are injected.

**Command:**
```
view_file("/Users/lvishwanath/Documents/cbp-test-automation/pages/fixture.ts")
```

**Output (Key Excerpt):**
```typescript
import { test as base } from '@playwright/test'
import LoginPage from './loginPage'
import LayoutPage from './layoutPage'

type MyFixtures = {
  loginPage: LoginPage
  layoutPage: LayoutPage
  // ...
}

export const test = base.extend<MyFixtures>({
  loginPage: async ({ page }, use) => {
    await use(new LoginPage(page))
  },
  layoutPage: async ({ page }, use) => {
    await use(new LayoutPage(page))
  },
  // ...
})
```

**Result: FixtureRegistry**
```json
{
  "loginPage": { "className": "LoginPage", "file": "loginPage.ts" },
  "layoutPage": { "className": "LayoutPage", "file": "layoutPage.ts" }
}
```

### 2.4 Tool Invocation: `view_file_outline` (Page Object Indexing)

**Purpose:** Build index of existing locators.

**Command:**
```
view_file_outline("/Users/lvishwanath/Documents/cbp-test-automation/pages/loginPage.ts")
```

**Output:**
```
Class: LoginPage extends BasePage
  Properties:
    - usernameTxtbx (line 8)
    - passwordTxtbx (line 12)
    - signInBtn (line 16)
  Methods:
    - loginToSaas() (line 20)
    - loginWithStorageState() (line 35)
```

**Extracted Locators from `loginPage.ts`:**
```json
[
  { "propertyName": "usernameTxtbx", "selectorValue": "email", "type": "role" },
  { "propertyName": "passwordTxtbx", "selectorValue": "password", "type": "role" },
  { "propertyName": "signInBtn", "selectorValue": "sign-in-button", "type": "testid" }
]
```

---

## 3. Phase II Execution: Parsing

### 3.1 Tokenization

**Executor:** LLM (TypeScript AST Knowledge)

**Process:** For each line of the raw script, extract structured tokens.

**Input Lines & Extracted Tokens:**

| Line | Raw Code | Token |
| ---- | -------- | ----- |
| 4 | `page.goto('https://cloudbees.io/')` | `{ action: "goto", value: "https://cloudbees.io/" }` |
| 7 | `page.getByRole('textbox', { name: 'Email' }).fill('user@example.com')` | `{ action: "fill", locator: { type: "role", value: "textbox", options: { name: "Email" } }, value: "user@example.com" }` |
| 8 | `page.getByRole('textbox', { name: 'Password' }).fill('password123')` | `{ action: "fill", locator: { type: "role", value: "textbox", options: { name: "Password" } }, value: "password123" }` |
| 9 | `page.getByRole('button', { name: 'Sign in' }).click()` | `{ action: "click", locator: { type: "role", value: "button", options: { name: "Sign in" } } }` |
| 10 | `page.waitForURL('**/home')` | `{ action: "waitForURL", value: "**/home" }` |
| 13 | `page.getByTestId('user-profile-dropdown').click()` | `{ action: "click", locator: { type: "testid", value: "user-profile-dropdown" } }` |
| 14 | `const themeToggle = page.getByTestId('theme-switcher')` | `{ action: "assign", variable: "themeToggle", locator: { type: "testid", value: "theme-switcher" } }` |
| 15 | `await themeToggle.textContent()` | `{ action: "textContent", actor: "themeToggle" }` |
| 18/21 | `await themeToggle.click()` | `{ action: "click", actor: "themeToggle" }` |
| 19/22 | `expect(page.locator('main')).toHaveCSS(...)` | `{ action: "expect", locator: { type: "css", value: "main" }, assertion: "toHaveCSS" }` |

### 3.2 Clustering

**Executor:** LLM (Semantic Reasoning)

**Resulting Clusters:**

```json
[
  {
    "id": "cluster_1",
    "type": "NAVIGATION",
    "intent": "Navigate to application",
    "tokens": [
      { "action": "goto", "value": "https://cloudbees.io/" }
    ]
  },
  {
    "id": "cluster_2",
    "type": "AUTHENTICATION",
    "intent": "Login to the application",
    "tokens": [
      { "action": "fill", "locator": "Email" },
      { "action": "fill", "locator": "Password" },
      { "action": "click", "locator": "Sign in" },
      { "action": "waitForURL", "value": "**/home" }
    ]
  },
  {
    "id": "cluster_3",
    "type": "MENU_INTERACTION",
    "intent": "Toggle application theme",
    "tokens": [
      { "action": "click", "locator": "user-profile-dropdown" },
      { "action": "textContent", "actor": "themeToggle" },
      { "action": "click", "actor": "themeToggle" }
    ]
  },
  {
    "id": "cluster_4",
    "type": "VERIFICATION",
    "intent": "Verify theme change",
    "tokens": [
      { "action": "expect", "locator": "main", "assertion": "toHaveCSS" }
    ]
  }
]
```

### 3.3 Variable Resolution

**Executor:** LLM (Code Analysis)

**Analysis:**
*   `const themeToggle = page.getByTestId('theme-switcher')` -> **This is a locator variable**. It should become a Page Object property.
*   The hardcoded credentials `'user@example.com'` and `'password123'` -> **Test data**. Should remain in the test file (or use environment variables).
*   `const currentTheme = await themeToggle.textContent()` -> **Runtime value**. Stays in test logic.

**Result: Test Data Extraction**
```typescript
const EMAIL = 'user@example.com';  // Move to top of test file
const PASSWORD = 'password123';     // Move to top of test file
const LIGHT_MODE_BG = 'rgb(250, 250, 250)';
const DARK_MODE_BG = 'rgb(26, 26, 26)';
```

---

## 4. Phase III Execution: Mapping

### 4.1 Direct Hit Search

**Executor:** Tool (`grep_search`)

**Query 1: Search for `user-profile-dropdown`**
```
grep_search(path="pages/", query="user-profile-dropdown")
```
**Result:**
```
pages/layoutPage.ts:15:  public userProfileBtn = new WebControl(this.page.getByTestId('user-profile-dropdown'), 'User Profile Button')
```
**Verdict:** `user-profile-dropdown` is **already defined** in `LayoutPage.ts`. Reuse `userProfileBtn`.

**Query 2: Search for `theme-switcher`**
```
grep_search(path="pages/", query="theme-switcher")
```
**Result:**
```
No matches found.
```
**Verdict:** `theme-switcher` is an **orphan selector**. Needs to be added to a Page Object.

**Query 3: Search for `main` (CSS selector)**
```
grep_search(path="pages/", query="locator('main')")
```
**Result:**
```
No matches found.
```
**Verdict:** `main` is also an **orphan**. Needs mapping.

### 4.2 Anchor Analysis

**Executor:** LLM (Contextual Reasoning)

**For `theme-switcher`:**
*   **Trace Predecessor:** `user-profile-dropdown` (Line 13 clicked before Line 14).
*   **Anchor Location:** `user-profile-dropdown` is in `LayoutPage.ts` (verified by Direct Hit).
*   **Inference:** `theme-switcher` appears AFTER clicking `user-profile-dropdown`. This means the theme switcher is inside the profile menu, which is part of the global layout.
*   **Decision:** `theme-switcher` **belongs in `LayoutPage.ts`**.

**For `main`:**
*   **Semantic Analysis:** `main` is an HTML5 structural element, typically the main content area.
*   **Scope:** This is a global element, present on all pages.
*   **Decision:** `main` **belongs in `LayoutPage.ts`** (or `BasePage.ts` if it's truly universal).

### 4.3 Semantic Scoring (Verification)

**Executor:** LLM (Keyword Matching)

**Orphan: `theme-switcher`**
*   Keywords: ["theme", "switcher", "mode", "dark", "light"]

**Candidate: LoginPage**
*   Profile: ["login", "email", "password", "auth", "signin"]
*   Overlap Score: 0.0 (No match)

**Candidate: LayoutPage**
*   Profile: ["layout", "header", "profile", "menu", "logout", "welcome"]
*   Overlap Score: 0.2 (Low, but "profile" is related to "menu" which opens the switcher)

**Candidate: DashboardPage**
*   Profile: ["dashboard", "widget", "stats", "chart"]
*   Overlap Score: 0.0 (No match)

**Anchor Boost:** +0.5 for `LayoutPage` because the anchor (`user-profile-dropdown`) is there.

**Final Scores:**
*   LoginPage: 0.0
*   LayoutPage: 0.2 + 0.5 = 0.7 ✓ **WINNER**
*   DashboardPage: 0.0

### 4.4 Final Mapping Table

| Orphan Selector | Target Page Object | Property Name | Is New? | Confidence |
| --------------- | ------------------ | ------------- | ------- | ---------- |
| `theme-switcher` | LayoutPage | `themeSwitcher` | Yes | 0.85 |
| `main` | LayoutPage | `mainContent` | Yes | 0.90 |

---

## 5. Phase IV Execution: Code Generation

### 5.1 Property Generation (Chameleon Strategy)

**Input:**
*   Orphan: `{ type: "testid", value: "theme-switcher" }`
*   Target: `LayoutPage`
*   Style: `{ locatorStyle: "WrapperClass", wrapperClassName: "WebControl", visibility: "public" }`

**Generated Code:**
```typescript
public themeSwitcher = new WebControl(
  this.page.getByTestId('theme-switcher'),
  'Theme Switcher Toggle'
)

public mainContent = this.page.locator('main')
```

**Note:** `mainContent` uses native locator because it doesn't need the `WebControl` wrapper (it's for evaluation, not interaction).

### 5.2 Method Generation

**Intent:** "Toggle the theme"
**Required Actions:** Click `themeSwitcher`.

**Initial Generated Method:**
```typescript
public async toggleTheme() {
  await this.click(this.userProfileBtn)  // Open menu
  await this.click(this.themeSwitcher)   // Click toggle
}
```

**Problem Encountered:** During verification (Phase V), this caused a "Click Intercepted" error because the menu was already open when the test called `toggleTheme()` after reading the theme text.

**Refined Method (After Verification Loop):**
```typescript
public async toggleTheme() {
  await this.click(this.themeSwitcher)  // Just click the toggle (menu assumed open)
}
```

**Additional Support Methods:**
```typescript
public async getThemeSwitcherText() {
  return await this.themeSwitcher.controlLocator.textContent()
}

public async getBackgroundColor() {
  return await this.mainContent.evaluate(el => {
    return window.getComputedStyle(el).backgroundColor
  })
}
```

### 5.3 Test File Generation

**Generated File: `tests/smoke/theme.smoke.test.ts`**

```typescript
import { test } from '../../pages/fixture'
import { expect } from '@playwright/test'
import { TestTags } from '../../utils/testTags'

test.describe('Theme Toggle Validation', () => {
  const LIGHT_MODE_BG = 'rgb(250, 250, 250)'
  const DARK_MODE_BG = 'rgb(26, 26, 26)'
  const EMAIL = 'cbp-qa-automation+btautomation@beescloud.com'
  const PASSWORD = 'MyPassword1!'

  test(
    'QA Test: Login and Theme Toggle Validation',
    { tag: [TestTags.UI_SMOKE_TEST] },
    async ({ loginPage, layoutPage }) => {
      // 1. Login to the application
      await loginPage.initializeBrowser()
      await loginPage.type(loginPage.usernameTxtbx, EMAIL)
      await loginPage.type(loginPage.passwordTxtbx, PASSWORD)
      await loginPage.click(loginPage.signInBtn)
      
      // Wait for login to complete
      await expect(layoutPage.welcomeTitle.controlLocator).toBeVisible({ timeout: 30000 })

      // 2. Open User Profile Menu
      await layoutPage.click(layoutPage.userProfileBtn)

      // 3. Determine current theme state
      const currentToggleText = await layoutPage.getThemeSwitcherText()
      let expectedFinalColor = ''

      if (currentToggleText?.includes('Light mode')) {
        expectedFinalColor = LIGHT_MODE_BG
      } else if (currentToggleText?.includes('Dark mode')) {
        expectedFinalColor = DARK_MODE_BG
      }

      // 4. Toggle theme
      await layoutPage.toggleTheme()

      // 5. Validate background color
      await expect.poll(
        async () => await layoutPage.getBackgroundColor(),
        { message: 'Background color should change', timeout: 15000 }
      ).toBe(expectedFinalColor)
    },
  )
})
```

### 5.4 Import Statement Resolution

**Detected Imports:**
*   `test` from `../../pages/fixture` (Fixture injection)
*   `expect` from `@playwright/test`
*   `TestTags` from `../../utils/testTags` (for tagging)

---

## 6. Phase V Execution: Verification

### 6.1 First Test Run

**Command:**
```bash
npx playwright test tests/smoke/theme.smoke.test.ts --project=chrome
```

**Result:** FAILURE

**Error:**
```
Error: locator.click: Timeout 60000ms exceeded.
Call log:
  - waiting for locator.getByTestId('theme-switcher')
```

**Analysis (LLM):**
*   The `theme-switcher` element was not visible.
*   **Root Cause:** The test called `getThemeSwitcherText()` BEFORE opening the profile menu. The element is inside the menu.

**Fix:** Add menu opening to `getThemeSwitcherText()`.

### 6.2 Second Test Run

**Command:**
```bash
npx playwright test tests/smoke/theme.smoke.test.ts --project=chrome
```

**Result:** FAILURE

**Error:**
```
Error: locator.click: Timeout 60000ms exceeded.
  Element is intercepted by MuiBackdrop-root
```

**Analysis (LLM):**
*   The `toggleTheme()` method was trying to click `userProfileBtn` again.
*   But the menu was ALREADY open from the previous step (reading text).
*   The menu's backdrop was intercepting the click.

**Fix:** Separate the menu opening (done in test) from the toggle click (done in method).

### 6.3 Third Test Run (Success)

**Command:**
```bash
npx playwright test tests/smoke/theme.smoke.test.ts --project=chrome
```

**Result:** PASS ✓

**Final Verification Log:**
```
Running 1 test using 1 worker
[chrome] › theme.smoke.test.ts:11:9 › Theme Toggle Validation
  ✓ QA Test: Login and Theme Toggle Validation (25.6s)
  1 passed (25.6s)
```

---

## 7. Tool Invocation Log

| Step | Tool | Purpose | Outcome |
| ---- | ---- | ------- | ------- |
| 1 | `list_dir` | Discover repo structure | Found `pages/`, `tests/`, `fixtures.ts` |
| 2 | `view_file` | Pattern recognition (LayoutPage) | Detected `WrapperClass` style |
| 3 | `view_file` | Parse fixture registry | Mapped `loginPage`, `layoutPage` |
| 4 | `view_file_outline` | Index LoginPage | Extracted existing locators |
| 5 | `grep_search` | Direct hit for `user-profile-dropdown` | Found in LayoutPage |
| 6 | `grep_search` | Direct hit for `theme-switcher` | Not found (orphan) |
| 7 | `write_to_file` | Add properties to LayoutPage | Created `themeSwitcher` property |
| 8 | `write_to_file` | Create test file | Generated `theme.smoke.test.ts` |
| 9 | `run_command` | Execute test | Failed (element not visible) |
| 10 | `browser_subagent` | Analyze failure screenshot | Identified menu state issue |
| 11 | `replace_file_content` | Fix `getThemeSwitcherText` | Added menu open step |
| 12 | `run_command` | Execute test | Failed (backdrop interception) |
| 13 | `browser_subagent` | Analyze failure | Identified redundant click |
| 14 | `replace_file_content` | Fix `toggleTheme` | Removed menu open from method |
| 15 | `run_command` | Execute test | PASSED ✓ |

---

## 8. LLM vs Tool Responsibility Matrix

| Task | Executor | Reasoning |
| ---- | -------- | --------- |
| Directory listing | **Tool** (`list_dir`) | Deterministic file system operation |
| File reading | **Tool** (`view_file`) | Deterministic I/O |
| Pattern detection (Style) | **LLM** | Requires semantic understanding of code |
| Tokenization | **LLM** | AST-level parsing requires language knowledge |
| Clustering | **LLM** | Semantic grouping based on intent |
| Direct Hit searching | **Tool** (`grep_search`) | Text matching |
| Anchor analysis | **LLM** | Contextual reasoning about action sequences |
| Semantic scoring | **LLM** | Keyword embedding / matching |
| Code generation | **LLM** | Syntax-aware code writing |
| Test execution | **Tool** (`run_command`) | Shell execution |
| Error parsing | **LLM** | Understanding stack traces |
| Fix determination | **LLM** | Root cause analysis |
| Code modification | **Tool** (`replace_file_content`) | File modification |

---

## END OF OPUS WORKED EXAMPLE

This document demonstrates the complete execution trace from raw input to verified output, with every decision point explicitly documented for replication by an autonomous agent.
